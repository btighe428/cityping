# Content Routing Flowchart

## Main Decision Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        CONTENT ARRIVES                                       │
│                             │                                                │
│                             ▼                                                │
│                    ┌────────────────┐                                        │
│                    │ Check Freshness │                                       │
│                    └───────┬────────┘                                        │
│                            │                                                 │
│            ┌───────────────┼───────────────┐                                │
│            │               │               │                                │
│            ▼               ▼               ▼                                │
│         FRESH          TOO OLD         EXPIRED                              │
│            │               │               │                                │
│            │               ▼               ▼                                │
│            │           ┌───────┐       ┌───────┐                            │
│            │           │ SKIP  │       │ SKIP  │                            │
│            │           └───────┘       └───────┘                            │
│            │                                                                 │
│            ▼                                                                 │
│   ┌────────────────┐                                                        │
│   │ Check Urgency  │                                                        │
│   └───────┬────────┘                                                        │
│           │                                                                 │
│   ┌───────┴───────┬───────────────┬───────────────┐                        │
│   │               │               │               │                        │
│   ▼               ▼               ▼               ▼                        │
│ URGENT     TIME-SENSITIVE    EVERGREEN       BATCHABLE                     │
│   │               │               │               │                        │
│   ▼               │               │               │                        │
│ Priority         │               │               │                        │
│ >= 80?           │               │               │                        │
│   │               │               │               │                        │
│   ├─ YES ────────────────────────────────────────────► SEND IMMEDIATE     │
│   │               │               │               │                        │
│   ├─ NO ─────────►│               │               │                        │
│   │               │               │               │                        │
│   │               ▼               ▼               ▼                        │
│   │        ┌────────────────────────────────────────┐                      │
│   │        │        CHECK DEDUPLICATION             │                      │
│   │        └───────────────┬────────────────────────┘                      │
│   │                        │                                               │
│   │            ┌───────────┼───────────┐                                   │
│   │            │           │           │                                   │
│   │            ▼           ▼           ▼                                   │
│   │         NEW      DUPLICATE    DUPLICATE                                │
│   │            │      (no change)  (changed)                               │
│   │            │           │           │                                   │
│   │            │           ▼           │                                   │
│   │            │       ┌───────┐       │                                   │
│   │            │       │ SKIP  │       │                                   │
│   │            │       └───────┘       │                                   │
│   │            │                       │                                   │
│   │            └───────────┬───────────┘                                   │
│   │                        │                                               │
│   │                        ▼                                               │
│   │              ┌──────────────────┐                                      │
│   │              │ Check Slot Match │                                      │
│   │              └────────┬─────────┘                                      │
│   │                       │                                                │
│   │       ┌───────────────┴───────────────┐                               │
│   │       │                               │                               │
│   │       ▼                               ▼                               │
│   │  PREFERRED SLOT              NOT PREFERRED SLOT                       │
│   │       │                               │                               │
│   │       │                               ▼                               │
│   │       │                       ┌───────────────┐                       │
│   │       │                       │ Can defer to  │                       │
│   │       │                       │ preferred?    │                       │
│   │       │                       └───────┬───────┘                       │
│   │       │                               │                               │
│   │       │               ┌───────────────┴───────────────┐              │
│   │       │               │                               │              │
│   │       │               ▼                               ▼              │
│   │       │              YES                              NO             │
│   │       │               │                               │              │
│   │       │               ▼                               │              │
│   │       │           ┌───────────┐                       │              │
│   │       │           │   DEFER   │                       │              │
│   │       │           │ to slot   │                       │              │
│   │       │           └───────────┘                       │              │
│   │       │                                               │              │
│   │       └───────────────────────┬───────────────────────┘              │
│   │                               │                                      │
│   │                               ▼                                      │
│   │                       ┌───────────────┐                              │
│   │                       │   INCLUDE     │                              │
│   │                       │  in slot      │                              │
│   │                       └───────────────┘                              │
│   │                                                                      │
└───┴──────────────────────────────────────────────────────────────────────┘
```

## Slot Assembly Flow

```
                        FOR EACH SLOT (9am, 12pm, 6pm)
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │   Gather Routed Content       │
                    │   (INCLUDE decisions only)    │
                    └──────────────┬────────────────┘
                                   │
                                   ▼
                    ┌───────────────────────────────┐
                    │   Sort by Priority (desc)     │
                    └──────────────┬────────────────┘
                                   │
                                   ▼
                    ┌───────────────────────────────┐
                    │   Check Item Count            │
                    └──────────────┬────────────────┘
                                   │
         ┌─────────────────────────┼─────────────────────────┐
         │                         │                         │
         ▼                         ▼                         ▼
    BELOW MIN               WITHIN LIMITS              ABOVE MAX
         │                         │                         │
         ▼                         │                         ▼
┌─────────────────┐                │              ┌─────────────────┐
│ Has required    │                │              │ Apply overflow  │
│ content?        │                │              │ rules           │
└────────┬────────┘                │              └────────┬────────┘
         │                         │                       │
    ┌────┴────┐                    │                       │
    │         │                    │                       ▼
    ▼         ▼                    │              ┌─────────────────┐
   YES        NO                   │              │ • Keep urgent   │
    │         │                    │              │ • Keep high-pri │
    │         ▼                    │              │ • Defer rest    │
    │    ┌─────────┐               │              │ • Drop low-pri  │
    │    │  SKIP   │               │              │   time-sens     │
    │    │  SLOT   │               │              └────────┬────────┘
    │    └─────────┘               │                       │
    │                              │                       │
    └──────────────────────────────┴───────────────────────┘
                                   │
                                   ▼
                    ┌───────────────────────────────┐
                    │   Final content list ready    │
                    └──────────────┬────────────────┘
                                   │
                                   ▼
                    ┌───────────────────────────────┐
                    │   Generate email template     │
                    └───────────────────────────────┘
```

## Deduplication Decision Tree

```
               Content Item
                    │
                    ▼
        ┌───────────────────────┐
        │ Exists in send history│
        │ (last 24h)?           │
        └───────────┬───────────┘
                    │
           ┌───────┴───────┐
           │               │
           ▼               ▼
          NO              YES
           │               │
           │               ▼
           │    ┌─────────────────────┐
           │    │ Is this a STATUS    │
           │    │ CHANGE?             │
           │    │ (e.g. ASP:suspended │
           │    │  → ASP:in_effect)   │
           │    └─────────┬───────────┘
           │              │
           │     ┌────────┴────────┐
           │     │                 │
           │     ▼                 ▼
           │    YES                NO
           │     │                 │
           │     │                 ▼
           │     │    ┌─────────────────────┐
           │     │    │ Priority increased  │
           │     │    │ by 30+ points?      │
           │     │    └─────────┬───────────┘
           │     │              │
           │     │     ┌────────┴────────┐
           │     │     │                 │
           │     │     ▼                 ▼
           │     │    YES                NO
           │     │     │                 │
           │     │     │                 ▼
           │     │     │           ┌───────────┐
           │     │     │           │   SKIP    │
           │     │     │           │ (dup, no  │
           │     │     │           │  update)  │
           │     │     │           └───────────┘
           │     │     │
           │     └─────┴───────────┐
           │                       │
           └───────────────────────┴───────────┐
                                               │
                                               ▼
                                     ┌─────────────────┐
                                     │    INCLUDE      │
                                     │ (new or update) │
                                     └─────────────────┘
```

## Time Slot Selection

```
                    Content Type
                         │
           ┌─────────────┼─────────────┬─────────────┐
           │             │             │             │
           ▼             ▼             ▼             ▼
    ASP-related    Transit-related  Weather    News/Events
           │             │             │             │
           │             │             │             │
    ┌──────┴──────┐      │             │             │
    │             │      │             │             │
    ▼             ▼      │             │             │
 asp_status   asp_tomorrow             │             │
 asp_in_effect                         │             │
 asp_suspension                        │             │
    │             │      │             │             │
    │             │      │             │             │
    ▼             ▼      │             │             │
 ┌─────────┐  ┌─────────┐│             │             │
 │ MORNING │  │ EVENING ││             │             │
 │  (9am)  │  │  (6pm)  ││             │             │
 └─────────┘  └─────────┘│             │             │
                         │             │             │
                         ▼             │             │
              ┌──────────────────┐     │             │
              │ Transit delays?  │     │             │
              └────────┬─────────┘     │             │
                       │               │             │
              ┌────────┴────────┐      │             │
              │                 │      │             │
              ▼                 ▼      │             │
           ACTIVE           PLANNED    │             │
              │                 │      │             │
              ▼                 ▼      │             │
         ┌─────────┐      ┌─────────┐  │             │
         │ MORNING │      │ EVENING │  │             │
         │ MIDDAY  │      │ MORNING │  │             │
         └─────────┘      └─────────┘  │             │
                                       │             │
                                       ▼             │
                            ┌──────────────────┐     │
                            │ Severe?          │     │
                            └────────┬─────────┘     │
                                     │               │
                            ┌────────┴────────┐      │
                            │                 │      │
                            ▼                 ▼      │
                           YES                NO     │
                            │                 │      │
                            ▼                 ▼      │
                      ┌─────────┐      ┌─────────┐   │
                      │ IMMEDIATE      │ MORNING │   │
                      │ (any slot)     │ EVENING │   │
                      └─────────┘      └─────────┘   │
                                                     │
                                                     ▼
                                          ┌──────────────────┐
                                          │ Breaking?        │
                                          └────────┬─────────┘
                                                   │
                                          ┌────────┴────────┐
                                          │                 │
                                          ▼                 ▼
                                         YES                NO
                                          │                 │
                                          ▼                 ▼
                                    ┌─────────┐      ┌─────────┐
                                    │ IMMEDIATE      │ MIDDAY  │
                                    │ or MIDDAY │    │ EVENING │
                                    └─────────┘      └─────────┘
```

## Scarcity Handling

```
              Slot Item Count
                    │
                    ▼
        ┌───────────────────────┐
        │ Count < Minimum?      │
        └───────────┬───────────┘
                    │
           ┌───────┴───────┐
           │               │
           ▼               ▼
          NO              YES
           │               │
           │               ▼
           │    ┌─────────────────────┐
           │    │ Which slot?         │
           │    └─────────┬───────────┘
           │              │
           │    ┌─────────┼─────────┐
           │    │         │         │
           │    ▼         ▼         ▼
           │ MORNING   MIDDAY   EVENING
           │    │         │         │
           │    ▼         │         ▼
           │ Has ASP     │      Has asp_tomorrow
           │ status?     │      status?
           │    │         │         │
           │    ├─YES──►SEND        ├─YES──►SEND
           │    │         │         │
           │    ├─NO──►SKIP         ├─NO──►SKIP
           │              │
           │              ▼
           │       Item count?
           │              │
           │         ┌────┴────┐
           │         │         │
           │         ▼         ▼
           │       ZERO      1-2
           │         │         │
           │         ▼         ▼
           │      ┌──────┐   High
           │      │ SKIP │   priority?
           │      └──────┘     │
           │              ┌────┴────┐
           │              │         │
           │              ▼         ▼
           │            YES        NO
           │              │         │
           │              ▼         ▼
           │           SEND    COMBINE w/
           │                   EVENING
           │
           ▼
        PROCEED TO
         ASSEMBLY
```

## Abundance Handling

```
              Slot Item Count
                    │
                    ▼
        ┌───────────────────────┐
        │ Count > Maximum?      │
        └───────────┬───────────┘
                    │
           ┌───────┴───────┐
           │               │
           ▼               ▼
          NO              YES
           │               │
           │               ▼
           │    ┌─────────────────────┐
           │    │ Sort by priority    │
           │    └─────────┬───────────┘
           │              │
           │              ▼
           │    ┌─────────────────────┐
           │    │ For each item:      │
           │    └─────────┬───────────┘
           │              │
           │    ┌─────────┴─────────┐
           │    │                   │
           │    ▼                   │
           │  URGENT?               │
           │    │                   │
           │ ┌──┴──┐                │
           │ ▼     ▼                │
           │YES    NO               │
           │ │     │                │
           │ │     ▼                │
           │ │  Within limit?       │
           │ │     │                │
           │ │  ┌──┴──┐             │
           │ │  ▼     ▼             │
           │ │ YES    NO            │
           │ │  │     │             │
           │ │  │     ▼             │
           │ │  │  Urgency?         │
           │ │  │     │             │
           │ │  │  ┌──┴──────┬──────┐
           │ │  │  │         │      │
           │ │  │  ▼         ▼      ▼
           │ │  │ TIME-    EVER-  BATCH-
           │ │  │ SENS     GREEN   ABLE
           │ │  │  │         │      │
           │ │  │  ▼         ▼      ▼
           │ │  │ Pri      DEFER   DEFER
           │ │  │ >=60?      │      │
           │ │  │  │         │      │
           │ │  │ ┌┴─┐       │      │
           │ │  │ ▼  ▼       │      │
           │ │  │YES NO      │      │
           │ │  │ │  │       │      │
           │ │  │ │  ▼       │      │
           │ │  │ │ DROP     │      │
           │ │  │ │  │       │      │
           │ │  │ ▼  │       │      │
           │ │  │DEFER       │      │
           │ │  │            │      │
           │ └──┼─► KEEP ◄───┘      │
           │    │            │      │
           │    └────────────┴──────┘
           │
           ▼
        PROCEED TO
         ASSEMBLY
```
